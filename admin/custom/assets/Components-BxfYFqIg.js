import{j as e}from"./DefaultPropsProvider-CLe-DXgN.js";import{A as o}from"./AdminComponentEasyAccessSet__loadShare___mf_0_iobroker_mf_1_adapter_mf_2_react_mf_2_v5__loadShare__-CmYJ37BE.js";import{A as J,a as E}from"./AdminComponentEasyAccessSet__mf_v__runtimeInit__mf_v__-9o5tLcPN.js";import{A as t}from"./AdminComponentEasyAccessSet__loadShare___mf_0_mui_mf_1_material__loadShare__-EKOPJIKX.js";import{D as F,T as y,S as N,a as B,b as P,c as W}from"./Tram-DfEnfuV-.js";import{A as S}from"./AdminComponentEasyAccessSet__loadShare___mf_0_mui_mf_1_icons_mf_2_material__loadShare__-CljkirG-.js";import{A as k}from"./AdminComponentEasyAccessSet__loadShare__react__loadShare__-CJmceRyn.js";import"./createTheme-7CZNbMr1.js";import"./_commonjsHelpers-CE1G-McA.js";import"./createSvgIcon-BA2rfUM-.js";import"./defaultTheme-BJjGWN-J.js";const{loadShare:G}=E,{initPromise:V}=J,L=V.then(n=>G("@iobroker/json-config",{customShareInfo:{shareConfig:{singleton:!0,strictVersion:!1,requiredVersion:"*"}}})),M=await L.then(n=>n());var u=M;const A=[{value:"hafas:vbb",label:"HAFAS - VBB (Berlin/Brandenburg)",serviceType:"hafas",profile:"vbb"},{value:"hafas:oebb",label:"HAFAS - ÖBB (Österreich)",serviceType:"hafas",profile:"oebb"},{value:"vendo:db",label:"Vendo - Deutsche Bahn",serviceType:"vendo",profile:"db"}];class H extends u.ConfigGeneric{constructor(s){super(s),this.state={...this.state,alive:!1}}componentWillUnmount(){const s=this.props.oContext.instance??"0",a=this.props.oContext.adapterName;this.props.oContext.socket.unsubscribeState(`system.adapter.${a}.${s}.alive`,this.onAliveChanged)}async componentDidMount(){super.componentDidMount();const s=this.props.oContext.instance??"0",l=`system.adapter.${this.props.oContext.adapterName}.${s}.alive`;try{const i=await this.props.oContext.socket.getState(l),c=!!(i!=null&&i.val);this.setState({alive:c}),await this.props.oContext.socket.subscribeState(l,this.onAliveChanged)}catch(i){console.error("[PageConfig] Failed to get alive state or subscribe:",i),this.setState({alive:!1})}}onAliveChanged=(s,a)=>{const l=this.state.alive,i=a?!!a.val:!1;l!==i&&this.setState({alive:i})};renderItem(s,a){const l=u.ConfigGeneric.getValue(this.props.data,"serviceType"),i=u.ConfigGeneric.getValue(this.props.data,"profile"),c=`${l||"hafas"}:${i||"vbb"}`,d=u.ConfigGeneric.getValue(this.props.data,"clientName"),h=u.ConfigGeneric.getValue(this.props.data,"pollInterval"),r=u.ConfigGeneric.getValue(this.props.data,"logUnknownTokens"),x=u.ConfigGeneric.getValue(this.props.data,"suppressInfoLogs"),f=u.ConfigGeneric.getValue(this.props.data,"delayOffset"),j=async p=>{const b=parseInt(p.target.value,10);await this.onChange("pollInterval",isNaN(b)?5:b)},I=async p=>{const b=A.find($=>$.value===p.target.value);b&&(await this.onChange("serviceType",b.serviceType),await this.onChange("profile",b.profile))},T=async p=>{const b=p.target.value;await this.onChange("clientName",b)},m=async p=>{await this.onChange("logUnknownTokens",p.target.checked)},g=async p=>{await this.onChange("suppressInfoLogs",p.target.checked)},C=async p=>{const b=parseInt(p.target.value,2);await this.onChange("delayOffset",isNaN(b)?0:b)};return e.jsxs(t.Box,{sx:{p:{xs:1,sm:2},maxWidth:1200,mx:"auto"},children:[e.jsx(t.Typography,{variant:"h5",sx:{mb:{xs:2,sm:3},fontSize:{xs:"1.25rem",sm:"1.5rem"}},children:o.I18n.t("clientConfig_title")}),e.jsxs(t.Box,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2,mb:3},children:[e.jsxs(t.FormControl,{sx:{flex:{sm:"1 1 0"},minWidth:{xs:"100%",sm:200}},disabled:a,fullWidth:!0,children:[e.jsx(t.InputLabel,{id:"client-profile-label",children:o.I18n.t("clientConfig_profile_label")}),e.jsx(t.Select,{labelId:"client-profile-label",id:"client-profile-select",value:c,label:o.I18n.t("clientConfig_profile_label"),onChange:I,disabled:!this.state.alive,children:A.map(p=>e.jsx(t.MenuItem,{value:p.value,children:p.label},p.value))}),e.jsx(t.FormHelperText,{children:o.I18n.t("clientConfig_profile_helper")})]}),e.jsx(t.FormControl,{sx:{flex:{sm:"1 1 0"},minWidth:{xs:"100%",sm:200}},disabled:!this.state.alive,fullWidth:!0,children:e.jsx(t.TextField,{id:"client-name-input",label:o.I18n.t("clientConfig_clientName_label"),value:d||"",onChange:T,helperText:o.I18n.t("clientConfig_clientName_helper"),disabled:!this.state.alive,fullWidth:!0})})]}),e.jsx(t.Typography,{variant:"h5",sx:{mb:{xs:2,sm:3},fontSize:{xs:"1.25rem",sm:"1.5rem"}},children:o.I18n.t("settings_title")}),e.jsxs(t.Box,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2,mb:3},children:[e.jsx(t.FormControl,{sx:{flex:{sm:"1 1 0"},minWidth:{xs:"100%",sm:200}},disabled:!this.state.alive,fullWidth:!0,children:e.jsx(t.TextField,{label:o.I18n.t("clientConfig_pollInterval_label"),type:"number",value:h||0,onChange:j,fullWidth:!0,size:"small",inputProps:{min:5,step:1,max:60},helperText:o.I18n.t("clientConfig_pollInterval_helper")})}),e.jsxs(t.FormControl,{sx:{flex:{sm:"1 1 0"},minWidth:{xs:"100%",sm:200}},disabled:!this.state.alive,children:[e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:r||!1,onChange:m,disabled:!this.state.alive}),label:o.I18n.t("clientConfig_logUnknownTokens_label")}),e.jsx(t.FormHelperText,{children:o.I18n.t("clientConfig_logUnknownTokens_helper")})]}),e.jsxs(t.FormControl,{sx:{flex:{sm:"1 1 0"},minWidth:{xs:"100%",sm:200}},disabled:!this.state.alive,children:[e.jsx(t.FormControlLabel,{control:e.jsx(t.Checkbox,{checked:x||!1,onChange:g,disabled:!this.state.alive}),label:o.I18n.t("clientConfig_suppressInfoLogs_label")}),e.jsx(t.FormHelperText,{children:o.I18n.t("clientConfig_suppressInfoLogs_helper")})]}),e.jsx(t.FormControl,{sx:{flex:{sm:"1 1 0"},minWidth:{xs:"100%",sm:200}},disabled:!this.state.alive,fullWidth:!0,children:e.jsx(t.TextField,{label:o.I18n.t("clientConfig_delayOffset_label"),type:"number",value:f||2,onChange:C,fullWidth:!0,size:"small",inputProps:{min:5,step:1,max:60},helperText:o.I18n.t("clientConfig_delayOffset_helper")})})]})]})}}const w={suburban:!0,subway:!0,tram:!0,bus:!0,ferry:!0,regional:!0,regionalExpress:!0,nationalExpress:!0,national:!0,express:!0},_=n=>{if(!n)return;const s={};return Object.entries(n).forEach(([a,l])=>{l===!0&&(s[a]=!0)}),Object.keys(s).length>0?s:void 0},D=[{key:"express",label:"ice_ic_ec",icon:F,color:"#EC0016"},{key:"nationalExpress",label:"ice",icon:y,color:"#FF6F00"},{key:"national",label:"ic_ec",icon:y,color:"#FF8F00"},{key:"regionalExpress",label:"re",icon:y,color:"#709EBF"},{key:"regional",label:"re_rb",icon:y,color:"#1455C0"},{key:"suburban",label:"s_bahn",icon:y,color:"#008D4F"},{key:"subway",label:"u_bahn",icon:N,color:"#0065AE"},{key:"tram",label:"tram",icon:B,color:"#D5001C"},{key:"bus",label:"bus",icon:P,color:"#A5027D"},{key:"ferry",label:"ferry",icon:W,color:"#0080C8"}],z=({products:n,onChange:s,disabled:a=!1,availableProducts:l})=>{const i=(d,h)=>{s({...n,[d]:h})},c=l?D.filter(({key:d})=>d in l):D;return e.jsxs(t.Paper,{variant:"outlined",sx:{p:2},children:[e.jsx(t.Typography,{variant:"subtitle2",sx:{mb:1},children:o.I18n.t("transport_types")}),e.jsx(t.Box,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:c.map(({key:d,label:h,icon:r,color:x})=>e.jsx(t.FormControlLabel,{disabled:a,control:e.jsx(t.Checkbox,{checked:n[d]??!0,onChange:f=>i(d,f.target.checked),sx:{color:x,"&.Mui-checked":{color:x}},size:"small"}),label:e.jsxs(t.Box,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(r,{sx:{color:a?"grey.500":x,fontSize:20}}),e.jsx(t.Typography,{variant:"body2",color:a?"text.disabled":"text.primary",children:o.I18n.t(h)})]})},d))})]})},O=({station:n,onUpdate:s,alive:a})=>{const l=r=>{n&&s&&s(n.id,{customName:r.target.value})},i=r=>{n&&s&&s(n.id,{enabled:r.target.checked})},c=r=>{if(n&&s){const x=parseInt(r.target.value,10);!isNaN(x)&&x>0&&s(n.id,{numDepartures:x})}},d=r=>{if(n&&s){const x=parseInt(r.target.value,10);!isNaN(x)&&x>=0&&s(n.id,{offsetTime:x})}},h=r=>{n&&s&&s(n.id,{products:r})};return e.jsxs(t.Paper,{sx:{p:2,height:"100%"},children:[e.jsx(t.Typography,{variant:"h6",sx:{mb:2},children:o.I18n.t("station_configuration")}),n?e.jsxs(t.Box,{children:[e.jsxs(t.Typography,{variant:"body2",color:"text.secondary",sx:{mb:3},children:[o.I18n.t("configuration_for_station"),": ",n.name]}),e.jsxs(t.Box,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(t.TextField,{label:o.I18n.t("station_id"),value:n.id,disabled:!0,fullWidth:!0,size:"small"}),e.jsx(t.TextField,{label:o.I18n.t("station_name"),value:n.name,disabled:!0,fullWidth:!0,size:"small"}),e.jsx(t.TextField,{label:o.I18n.t("custom_name"),value:n.customName||n.name,onChange:l,fullWidth:!0,size:"small",helperText:o.I18n.t("custom_name_hint"),disabled:!a}),e.jsx(t.FormControlLabel,{control:e.jsx(t.Switch,{checked:n.enabled!==!1,onChange:i,disabled:!a}),label:o.I18n.t("enabled")}),e.jsx(t.TextField,{label:o.I18n.t("departure_count"),type:"number",value:n.numDepartures||3,onChange:c,fullWidth:!0,size:"small",inputProps:{min:1,max:50},helperText:o.I18n.t("departure_count_hint"),disabled:!a}),e.jsx(t.TextField,{label:o.I18n.t("offset_time"),type:"number",value:n.offsetTime||0,onChange:d,fullWidth:!0,size:"small",inputProps:{min:0},helperText:o.I18n.t("offset_time_hint"),disabled:!a}),e.jsx(t.Divider,{sx:{my:1}}),e.jsx(z,{products:n.products||w,onChange:h,disabled:n.enabled===!1||!a,availableProducts:n.availableProducts})]})]}):e.jsx(t.Box,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"80%",color:"text.secondary"},children:e.jsx(t.Typography,{variant:"body2",children:o.I18n.t("select_station_to_configure")})})]})},R=({stations:n,selectedStationId:s,onAddStation:a,onDeleteStation:l,onStationClick:i,alive:c})=>{const d=t.useTheme(),h=t.useMediaQuery(d.breakpoints.down("sm"));return e.jsxs(t.Paper,{sx:{p:2,height:"100%",minHeight:400,display:"flex",flexDirection:"column"},children:[e.jsxs(t.Box,{sx:{display:"flex",flexDirection:h?"column":"row",justifyContent:"space-between",alignItems:h?"stretch":"center",gap:1,mb:2},children:[e.jsx(t.Typography,{variant:"h6",children:o.I18n.t("stations_overview")}),e.jsx(t.Button,{variant:"contained",startIcon:e.jsx(S.Add,{}),onClick:a,size:"small",fullWidth:h,disabled:!c,children:o.I18n.t("add_station")})]}),e.jsx(t.Box,{sx:{flexGrow:1,overflow:"auto"},children:n.length===0?e.jsx(t.Box,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",color:"text.secondary"},children:e.jsx(t.Typography,{variant:"body2",children:o.I18n.t("no_stations_hint")})}):e.jsx(t.List,{children:n.map(r=>e.jsxs(t.ListItemButton,{selected:s===r.id,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,mb:1,opacity:r.enabled===!1?.5:1,"&.Mui-selected":{backgroundColor:"action.selected"}},onClick:()=>i(r.id),disabled:!c,children:[e.jsx(t.ListItemText,{primary:r.customName||r.name,secondary:e.jsxs(e.Fragment,{children:[e.jsxs(t.Typography,{component:"span",variant:"caption",display:"block",children:["ID: ",r.id]}),r.customName&&r.customName!==r.name&&e.jsxs(t.Typography,{component:"span",variant:"caption",display:"block",color:"text.secondary",children:["Original: ",r.name]}),e.jsx(t.Typography,{component:"span",variant:"caption",display:"block",children:r.enabled===!1?o.I18n.t("disabled"):o.I18n.t("active")}),r.client_profile&&e.jsx(t.Typography,{component:"span",variant:"caption",display:"block",children:r.client_profile})]}),primaryTypographyProps:{fontWeight:500},secondaryTypographyProps:{component:"div"}}),e.jsx(t.IconButton,{edge:"end","aria-label":"delete",onClick:x=>{x.stopPropagation(),l(r.id)},size:"small",children:e.jsx(S.Delete,{})})]},r.id))})})]})};class v extends u.ConfigGeneric{searchTimeout=null;constructor(s){super(s),this.state={...this.state,searchQuery:"",stations:[],selectedStation:null,loading:!1,error:null}}handleClose=()=>{this.props.onClose&&this.props.onClose(),this.setState({searchQuery:"",stations:[],selectedStation:null,error:null})};handleSearchChange=s=>{const a=s.target.value;this.setState({searchQuery:a}),this.searchTimeout&&clearTimeout(this.searchTimeout),a.length>=2?this.searchTimeout=setTimeout(()=>{this.searchStations(a)},500):this.setState({stations:[],selectedStation:null})};searchStations=async s=>{this.setState({loading:!0,error:null});try{const a=await this.props.oContext.socket.sendTo(`${this.props.oContext.adapterName}.${this.props.oContext.instance}`,"location",{query:s});console.log("Search result:",a),console.log("Result type:",typeof a,"Is array:",Array.isArray(a)),a&&Array.isArray(a)?(console.log("Number of stations:",a.length),a.length>0&&console.log("First station:",JSON.stringify(a[0],null,2)),this.setState({stations:a,loading:!1})):this.setState({stations:[],loading:!1,error:o.I18n.t("stationSearch_no_results_found")})}catch(a){console.error("Search error:",a),this.setState({loading:!1,error:o.I18n.t("stationSearch_error").replace("%s",a instanceof Error?a.message:String(a))})}};handleStationSelect=s=>{this.setState({selectedStation:s})};handleConfirm=()=>{this.state.selectedStation&&(console.log("Confirming station:",this.state.selectedStation),this.props.onStationSelected&&this.props.onStationSelected(this.state.selectedStation.id,this.state.selectedStation.name,this.state.selectedStation.products),this.handleClose())};getProductIcons=s=>{if(!s)return console.log("No products provided"),[];console.log("Products:",s);const a=[],l={tram:{icon:e.jsx(B,{fontSize:"small"}),label:"tram",color:"#D5001C"},bus:{icon:e.jsx(P,{fontSize:"small"}),label:"bus",color:"#A5027D"},subway:{icon:e.jsx(N,{fontSize:"small"}),label:"u_bahn",color:"#0065AE"},express:{icon:e.jsx(F,{fontSize:"small"}),label:"ice_ic_ec",color:"#EC0016"},regional:{icon:e.jsx(y,{fontSize:"small"}),label:"re_rb",color:"#1455C0"},regionalExpress:{icon:e.jsx(y,{fontSize:"small"}),label:"re",color:"#709EBF"},nationalExpress:{icon:e.jsx(y,{fontSize:"small"}),label:"ice",color:"#FF6F00"},national:{icon:e.jsx(y,{fontSize:"small"}),label:"ic_ec",color:"#FF8F00"},ferry:{icon:e.jsx(W,{fontSize:"small"}),label:"ferry",color:"#0080C8"},suburban:{icon:e.jsx(y,{fontSize:"small"}),label:"s_bahn",color:"#008D4F"}};return Object.entries(s).forEach(([i,c])=>{console.log(`Product ${i}: ${c}`),c&&l[i]&&a.push(e.jsx(t.Tooltip,{title:o.I18n.t(l[i].label),arrow:!0,children:e.jsx(t.Box,{component:"span",title:l[i].label,sx:{display:"inline-flex",alignItems:"center",color:l[i].color,mr:1},children:l[i].icon},i)},i))}),console.log("Generated icons count:",a.length),a};renderItem(s,a){const{searchQuery:l,stations:i,selectedStation:c,loading:d,error:h}=this.state;return e.jsxs(t.Dialog,{open:!0,onClose:this.handleClose,maxWidth:"sm",fullWidth:!0,children:[e.jsx(t.DialogTitle,{children:o.I18n.t("stationSearch_title")}),e.jsxs(t.DialogContent,{children:[e.jsx(t.TextField,{autoFocus:!0,fullWidth:!0,label:o.I18n.t("stationSearch_input_label"),value:l,onChange:this.handleSearchChange,placeholder:o.I18n.t("stationSearch_input_placeholder"),sx:{mt:2,mb:2}}),d&&e.jsx(t.Box,{sx:{display:"flex",justifyContent:"center",p:2},children:e.jsx(t.CircularProgress,{})}),h&&e.jsx(t.Typography,{color:"error",sx:{p:2,textAlign:"center"},children:h}),!d&&!h&&i.length>0&&e.jsx(t.List,{sx:{maxHeight:400,overflow:"auto"},children:i.map(r=>{var x,f;return e.jsx(t.ListItem,{disablePadding:!0,children:e.jsx(t.ListItemButton,{selected:(c==null?void 0:c.id)===r.id,onClick:()=>this.handleStationSelect(r),children:e.jsx(t.ListItemText,{primary:r.name,secondary:e.jsxs(t.Box,{sx:{mt:.5},children:[e.jsx(t.Typography,{variant:"caption",display:"block",sx:{mb:.5},children:r.type?`${r.type}${r.location?` (${(x=r.location.latitude)==null?void 0:x.toFixed(4)}, ${(f=r.location.longitude)==null?void 0:f.toFixed(4)})`:""}`:r.id}),r.products&&e.jsx(t.Box,{sx:{display:"flex",flexWrap:"wrap"},children:this.getProductIcons(r.products)})]})})})},r.id)})}),!d&&!h&&l.length>=2&&i.length===0&&e.jsx(t.Typography,{color:"text.secondary",sx:{p:2,textAlign:"center"},children:o.I18n.t("stationSearch_no_results")}),l.length<2&&e.jsx(t.Typography,{color:"text.secondary",sx:{p:2,textAlign:"center"},children:o.I18n.t("stationSearch_min_chars")})]}),e.jsxs(t.DialogActions,{children:[e.jsx(t.Button,{onClick:this.handleClose,children:o.I18n.t("stationSearch_cancel")}),e.jsx(t.Button,{onClick:this.handleConfirm,variant:"contained",disabled:!c,children:o.I18n.t("stationSearch_confirm")})]})]})}}class Q extends u.ConfigGeneric{constructor(s){super(s);const a=u.ConfigGeneric.getValue(this.props.data,"stationConfig"),l=Array.isArray(a)?a:[];this.state={...this.state,stations:l,selectedStationId:null,showSearchDialog:!1,alive:!1}}async componentDidMount(){const s=u.ConfigGeneric.getValue(this.props.data,"stationConfig");Array.isArray(s)&&this.setState({stations:s});const a=this.props.oContext.instance??"0",i=`system.adapter.${this.props.oContext.adapterName}.${a}.alive`;try{const c=await this.props.oContext.socket.getState(i),d=!!(c!=null&&c.val);this.setState({alive:d}),await this.props.oContext.socket.subscribeState(i,this.onAliveChanged)}catch(c){console.error("[PageConfig] Failed to get alive state or subscribe:",c),this.setState({alive:!1})}}componentWillUnmount(){const s=this.props.oContext.instance??"0",a=this.props.oContext.adapterName;this.props.oContext.socket.unsubscribeState(`system.adapter.${a}.${s}.alive`,this.onAliveChanged)}componentDidUpdate(s){if(s.data!==this.props.data){const a=u.ConfigGeneric.getValue(this.props.data,"stationConfig");Array.isArray(a)&&this.setState({stations:a})}}onAliveChanged=(s,a)=>{const l=this.state.alive,i=a?!!a.val:!1;l!==i&&this.setState({alive:i})};handleAddStation=()=>{this.setState({showSearchDialog:!0})};handleStationSelected=async(s,a,l)=>{const i=_(l),c=u.ConfigGeneric.getValue(this.props.data,"serviceType"),d=u.ConfigGeneric.getValue(this.props.data,"profile"),h=`${c||"unknown"}:${d||"unknown"}`,r={id:s,name:a,customName:a,enabled:!0,numDepartures:10,products:i?{...i}:{...w},availableProducts:i,client_profile:h};if(!this.state.stations.some(f=>f.id===s)){const f=[...this.state.stations,r];this.setState({stations:f,selectedStationId:s}),await this.onChange("stationConfig",f)}this.setState({showSearchDialog:!1})};handleDeleteStation=async s=>{const a=this.state.stations.filter(l=>l.id!==s);this.setState({stations:a}),await this.onChange("stationConfig",a),this.state.selectedStationId===s&&this.setState({selectedStationId:null})};handleStationUpdate=async(s,a)=>{const l=this.state.stations.map(i=>i.id===s?{...i,...a}:i);this.setState({stations:l}),await this.onChange("stationConfig",l)};handleStationClick=s=>{this.setState({selectedStationId:s})};handleCloseSearch=()=>{this.setState({showSearchDialog:!1})};render(){const{stations:s,selectedStationId:a,showSearchDialog:l}=this.state,i=s.find(c=>c.id===a)||null;return e.jsxs(t.Box,{sx:{height:"100%",p:{xs:1,sm:2}},children:[e.jsxs(t.Box,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,height:"100%",width:"100%"},children:[e.jsx(t.Box,{sx:{width:{xs:"100%",md:400},flexShrink:{md:0},minHeight:{xs:300,md:"auto"}},children:e.jsx(R,{stations:s,selectedStationId:a,onAddStation:this.handleAddStation,onDeleteStation:this.handleDeleteStation,onStationClick:this.handleStationClick,alive:this.state.alive})}),e.jsx(t.Box,{sx:{width:{xs:"100%",md:"calc(100% - 400px - 16px)"},maxWidth:{md:"500px"},flexGrow:{md:1},minHeight:{xs:200,md:"auto"}},children:e.jsx(O,{station:i,onUpdate:this.handleStationUpdate,alive:this.state.alive})})]}),e.jsx(t.Dialog,{open:l,onClose:this.handleCloseSearch,maxWidth:"md",fullWidth:!0,fullScreen:!1,sx:{"& .MuiDialog-paper":{m:{xs:1,sm:2},maxHeight:{xs:"calc(100% - 16px)",sm:"calc(100% - 64px)"},width:{xs:"calc(100% - 16px)",sm:"auto"}}},children:e.jsx(v,{...this.props,alive:this.state.alive,onStationSelected:this.handleStationSelected,onClose:this.handleCloseSearch})})]})}}const q=({journey:n,onUpdate:s,configProps:a,alive:l})=>{const[i,c]=k.useState(!1),[d,h]=k.useState(!1),r=m=>{n&&s&&s(n.id,{customName:m.target.value})},x=m=>{n&&s&&s(n.id,{enabled:m.target.checked})},f=m=>{if(n&&s){const g=parseInt(m.target.value,10);!isNaN(g)&&g>0&&s(n.id,{numResults:g})}},j=m=>{if(n&&s){let g=m;n.availableProducts&&(g={},Object.keys(n.availableProducts).forEach(C=>{const p=C;p in m&&(g[p]=m[p])})),s(n.id,{products:g})}},I=(m,g,C)=>{if(n&&s){const p=_(C);s(n.id,{fromStationId:m,fromStationName:g,availableProducts:p})}c(!1)},T=(m,g,C)=>{if(n&&s){const p=_(C),b=n.availableProducts?_({...n.availableProducts,...p}):p;s(n.id,{toStationId:m,toStationName:g,availableProducts:b})}h(!1)};return e.jsxs(e.Fragment,{children:[e.jsxs(t.Paper,{sx:{p:2,height:"100%"},children:[e.jsx(t.Typography,{variant:"h6",sx:{mb:2},children:o.I18n.t("journey_configuration")}),n?e.jsx(t.Box,{children:e.jsxs(t.Box,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(t.TextField,{label:o.I18n.t("journey_name"),value:n.customName,onChange:r,fullWidth:!0,size:"small",helperText:o.I18n.t("journey_name_hint"),disabled:!l}),e.jsxs(t.Box,{children:[e.jsx(t.TextField,{label:o.I18n.t("from_station"),value:n.fromStationName||"",disabled:!0,fullWidth:!0,size:"small",helperText:n.fromStationId?`ID: ${n.fromStationId}`:""}),e.jsx(t.Button,{variant:"outlined",size:"small",onClick:()=>c(!0),sx:{mt:1},fullWidth:!0,disabled:!l,children:n.fromStationName?o.I18n.t("change_from_station"):o.I18n.t("select_from_station")})]}),e.jsxs(t.Box,{children:[e.jsx(t.TextField,{label:o.I18n.t("to_station"),value:n.toStationName||"",disabled:!0,fullWidth:!0,size:"small",helperText:n.toStationId?`ID: ${n.toStationId}`:""}),e.jsx(t.Button,{variant:"outlined",size:"small",onClick:()=>h(!0),sx:{mt:1},fullWidth:!0,disabled:!l,children:n.toStationName?o.I18n.t("change_to_station"):o.I18n.t("select_to_station")})]}),e.jsx(t.FormControlLabel,{control:e.jsx(t.Switch,{checked:n.enabled!==!1,onChange:x,disabled:!l}),label:o.I18n.t("enabled")}),e.jsx(t.TextField,{label:o.I18n.t("journey_results_count"),type:"number",value:n.numResults||5,onChange:f,fullWidth:!0,size:"small",inputProps:{min:1,max:20},helperText:o.I18n.t("journey_results_count_hint"),disabled:!l}),e.jsx(t.Divider,{sx:{my:1}}),e.jsx(z,{products:n.products||w,onChange:j,disabled:n.enabled===!1||!l,availableProducts:n.availableProducts})]})}):e.jsx(t.Box,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"80%",color:"text.secondary"},children:e.jsx(t.Typography,{variant:"body2",children:o.I18n.t("select_journey_to_configure")})})]}),i&&n&&a&&e.jsx(t.Dialog,{open:i,onClose:()=>c(!1),maxWidth:"md",fullWidth:!0,fullScreen:!1,sx:{"& .MuiDialog-paper":{m:{xs:1,sm:2},maxHeight:{xs:"calc(100% - 16px)",sm:"calc(100% - 64px)"},width:{xs:"calc(100% - 16px)",sm:"auto"}}},children:e.jsx(v,{...a,onStationSelected:I,onClose:()=>c(!1)})}),d&&n&&a&&e.jsx(t.Dialog,{open:d,onClose:()=>h(!1),maxWidth:"md",fullWidth:!0,fullScreen:!1,sx:{"& .MuiDialog-paper":{m:{xs:1,sm:2},maxHeight:{xs:"calc(100% - 16px)",sm:"calc(100% - 64px)"},width:{xs:"calc(100% - 16px)",sm:"auto"}}},children:e.jsx(v,{...a,onStationSelected:T,onClose:()=>h(!1)})})]})},K=({journeys:n,selectedJourneyId:s,onAddJourney:a,onDeleteJourney:l,onJourneyClick:i,alive:c})=>{const d=t.useTheme(),h=t.useMediaQuery(d.breakpoints.down("sm"));return e.jsxs(t.Paper,{sx:{p:2,height:"100%",minHeight:400,display:"flex",flexDirection:"column"},children:[e.jsxs(t.Box,{sx:{display:"flex",flexDirection:h?"column":"row",justifyContent:"space-between",alignItems:h?"stretch":"center",gap:1,mb:2},children:[e.jsx(t.Typography,{variant:"h6",children:o.I18n.t("journeys_overview")}),e.jsx(t.Button,{variant:"contained",startIcon:e.jsx(S.Add,{}),onClick:a,size:"small",fullWidth:h,disabled:!c,children:o.I18n.t("add_journey")})]}),e.jsx(t.Box,{sx:{flexGrow:1,overflow:"auto"},children:n.length===0?e.jsx(t.Box,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",color:"text.secondary"},children:e.jsx(t.Typography,{variant:"body2",children:o.I18n.t("no_journeys_hint")})}):e.jsx(t.List,{children:n.map(r=>e.jsxs(t.ListItemButton,{selected:s===r.id,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,mb:1,opacity:r.enabled===!1?.5:1,"&.Mui-selected":{backgroundColor:"action.selected"}},onClick:()=>i(r.id),disabled:!c,children:[e.jsx(t.ListItemText,{primary:r.customName,secondary:e.jsxs(e.Fragment,{children:[r.fromStationName&&e.jsxs(t.Typography,{component:"span",variant:"caption",display:"block",children:[o.I18n.t("from"),": ",r.fromStationName]}),r.toStationName&&e.jsxs(t.Typography,{component:"span",variant:"caption",display:"block",children:[o.I18n.t("to"),": ",r.toStationName]}),e.jsx(t.Typography,{component:"span",variant:"caption",display:"block",children:r.enabled===!1?o.I18n.t("disabled"):o.I18n.t("active")}),r.client_profile&&e.jsx(t.Typography,{component:"span",variant:"caption",display:"block",children:r.client_profile})]}),primaryTypographyProps:{fontWeight:500},secondaryTypographyProps:{component:"div"}}),e.jsx(t.IconButton,{edge:"end","aria-label":"delete",onClick:x=>{x.stopPropagation(),l(r.id)},size:"small",children:e.jsx(S.Delete,{})})]},r.id))})})]})};class X extends u.ConfigGeneric{constructor(s){super(s);const a=u.ConfigGeneric.getValue(this.props.data,"journeyConfig"),l=Array.isArray(a)?a:[];this.state={...this.state,journeys:l,selectedJourneyId:null,alive:!1}}async componentDidMount(){super.componentDidMount();const s=u.ConfigGeneric.getValue(this.props.data,"journeyConfig");Array.isArray(s)&&this.setState({journeys:s});const a=this.props.oContext.instance??"0",i=`system.adapter.${this.props.oContext.adapterName}.${a}.alive`;try{const c=await this.props.oContext.socket.getState(i),d=!!(c!=null&&c.val);this.setState({alive:d}),await this.props.oContext.socket.subscribeState(i,this.onAliveChanged)}catch(c){console.error("[PageConfig] Failed to get alive state or subscribe:",c),this.setState({alive:!1})}}componentWillUnmount(){const s=this.props.oContext.instance??"0",a=this.props.oContext.adapterName;this.props.oContext.socket.unsubscribeState(`system.adapter.${a}.${s}.alive`,this.onAliveChanged)}componentDidUpdate(s){if(s.data!==this.props.data){const a=u.ConfigGeneric.getValue(this.props.data,"journeyConfig");Array.isArray(a)&&this.setState({journeys:a})}}onAliveChanged=(s,a)=>{const l=this.state.alive,i=a?!!a.val:!1;l!==i&&this.setState({alive:i})};handleAddJourney=()=>{const s=`journey_${Date.now()}`,a=u.ConfigGeneric.getValue(this.props.data,"serviceType"),l=u.ConfigGeneric.getValue(this.props.data,"profile"),i=`${a||"unknown"}:${l||"unknown"}`,c={id:s,customName:`Journey ${this.state.journeys.length+1}`,enabled:!0,numResults:5,client_profile:i},d=[...this.state.journeys,c];this.setState({journeys:d,selectedJourneyId:s}),this.onChange("journeyConfig",d)};handleDeleteJourney=async s=>{const a=this.state.journeys.filter(l=>l.id!==s);this.setState({journeys:a}),await this.onChange("journeyConfig",a),this.state.selectedJourneyId===s&&this.setState({selectedJourneyId:null})};handleJourneyUpdate=async(s,a)=>{const l=this.state.journeys.map(i=>i.id===s?{...i,...a}:i);this.setState({journeys:l}),await this.onChange("journeyConfig",l)};handleJourneyClick=s=>{this.setState({selectedJourneyId:s})};render(){const{journeys:s,selectedJourneyId:a}=this.state,l=s.find(i=>i.id===a)||null;return e.jsx(t.Box,{sx:{height:"100%",p:{xs:1,sm:2}},children:e.jsxs(t.Box,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:2,height:"100%",width:"100%"},children:[e.jsx(t.Box,{sx:{width:{xs:"100%",md:400},flexShrink:{md:0},minHeight:{xs:300,md:"auto"}},children:e.jsx(K,{journeys:s,selectedJourneyId:a,onAddJourney:this.handleAddJourney,onDeleteJourney:this.handleDeleteJourney,onJourneyClick:this.handleJourneyClick,alive:this.state.alive})}),e.jsx(t.Box,{sx:{width:{xs:"100%",md:"calc(100% - 400px - 16px)"},maxWidth:{md:"500px"},flexGrow:{md:1},minHeight:{xs:200,md:"auto"}},children:e.jsx(q,{journey:l,onUpdate:this.handleJourneyUpdate,configProps:this.props,alive:this.state.alive})})]})})}}const re={ClientConfig:H,DepartureManager:Q,JourneyManager:X,StationSearch:v};export{re as default};
